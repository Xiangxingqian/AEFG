package com.app.test.newMethod;

import soot.Local;
import soot.Modifier;
import soot.Scene;
import soot.SootClass;
import soot.SootField;
import soot.SootMethod;
import soot.VoidType;
import soot.jimple.IntConstant;
import soot.jimple.Jimple;
import soot.jimple.internal.JNewExpr;

import com.app.test.Main;
import com.app.test.MethodBuilder;
public class Clinit extends MethodBuilder{
	
	public static final String CLASSNAME = "<clinit>";
	public static final String SUBSIGNATURE = "void <clinit>()";
	SootField viewLinkedList;
	SootField listenerLinkedList;
	SootField isMyEvent;
	SootField activities;
	SootField unVisitedActivities;
	SootClass sootClass;
	SootField unVisitedActivities_mainActivity;
	SootField activities_mainActivity;
	Local linkedList;
	boolean main = false;
	public Clinit(SootClass sc, String subSignature, boolean main) {
		super(sc, subSignature);
		this.main = main;
	}

	@Override
	protected void addUnits() {
		linkedList = addLocal("linkedList", linkedList_Type);
		viewLinkedList = sc.getFieldByName(VIEWLINKEDLIST);
		listenerLinkedList = sc.getFieldByName(LISTENERLINKEDLIST);
		isMyEvent = sc.getFieldByName(ISMYEVENT);
		activities = sc.getFieldByName(ACTIVITIES);
		unVisitedActivities = sc.getFieldByName(UNVISITEDACTIVITIES);
		sootClass = Scene.v().getSootClass(Main.mainActivity);
		unVisitedActivities_mainActivity = sootClass.getFieldByName(UNVISITEDACTIVITIES);
		activities_mainActivity = sootClass.getFieldByName(ACTIVITIES);
		
		addAssignStmt(linkedList, new JNewExpr(linkedList_Type));
		addInvokeStmt(Jimple.v().newSpecialInvokeExpr(linkedList, linkedListInit_method.makeRef()));
		addAssignStmt(Jimple.v().newStaticFieldRef(viewLinkedList.makeRef()), linkedList);
		addAssignStmt(linkedList, new JNewExpr(linkedList_Type));
		addInvokeStmt(Jimple.v().newSpecialInvokeExpr(linkedList, linkedListInit_method.makeRef()));
		addAssignStmt(Jimple.v().newStaticFieldRef(listenerLinkedList.makeRef()), linkedList);
		addAssignStmt(Jimple.v().newStaticFieldRef(isMyEvent.makeRef()),IntConstant.v(0));
		
		addQueue(main);
		
		addReturnVoidStmt();
	}

	private void addQueue(boolean main) {
		if(main){
			addAssignStmt(linkedList, new JNewExpr(linkedList_Type));
			addInvokeStmt(Jimple.v().newSpecialInvokeExpr(linkedList, linkedListInit_method.makeRef()));
			addAssignStmt(Jimple.v().newStaticFieldRef(activities.makeRef()), linkedList);
			addAssignStmt(linkedList, new JNewExpr(linkedList_Type));
			addInvokeStmt(Jimple.v().newSpecialInvokeExpr(linkedList, linkedListInit_method.makeRef()));
			addAssignStmt(Jimple.v().newStaticFieldRef(unVisitedActivities.makeRef()), linkedList);
		}
		else {
			addAssignStmt(linkedList,Jimple.v().newStaticFieldRef(unVisitedActivities_mainActivity.makeRef()));
			addAssignStmt(Jimple.v().newStaticFieldRef(unVisitedActivities.makeRef()), linkedList);
			addAssignStmt(linkedList,Jimple.v().newStaticFieldRef(activities_mainActivity.makeRef()) );
			addAssignStmt(Jimple.v().newStaticFieldRef(activities.makeRef()), linkedList);
		}
	}

	@Override
	protected void newMethodName() {
		currentMethod = new SootMethod(CLASSNAME, paramTypes(), VoidType.v(),Modifier.STATIC);
	}
}
